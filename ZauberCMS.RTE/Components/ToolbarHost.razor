@using ZauberCMS.RTE.Models
@inject ToolbarDiscoveryService ToolbarDiscovery

@{
    var effectiveLayout = ToolbarLayout?.GetEffectiveLayout() ?? [];
}

@if (effectiveLayout.Any())
{
    @foreach (var layoutItem in effectiveLayout)
    {
        @if (layoutItem is ToolbarBlock block)
        {
            <div class="rte-toolbar-block @block.CssClass">
                @foreach (var itemId in block.Items)
                {
                    var item = ToolbarDiscovery.GetItem(itemId);
                    if (item != null)
                    {
                        @if (item.ItemType == ToolbarItemType.Dropdown)
                        {
                            <ToolbarDropdown Item="item"
                                           IsActive="item.IsActive(EditorState)"
                                           IsEnabled="item.IsEnabled(EditorState)"
                                           EditorState="EditorState"
                                           OnChildItemClick="HandleDropdownChildClick"
                                           OnDropdownCreated="RegisterDropdown" />
                        }
                        else
                        {
                            <ToolbarButton Item="item"
                                         IsActive="item.IsActive(EditorState)"
                                         IsEnabled="item.IsEnabled(EditorState)"
                                         OnClick="() => OnItemExecuted.InvokeAsync(itemId)" />
                        }
                    }
                }
            </div>
        }
        else if (layoutItem is ToolbarSeparator separator)
        {
            <div class="rte-toolbar-separator @separator.CssClass"></div>
        }
        else if (layoutItem is ToolbarItemReference itemRef)
        {
            var item = ToolbarDiscovery.GetItem(itemRef.ItemId);
            if (item != null)
            {
                <div class="rte-toolbar-single-item @itemRef.CssClass">
                    @if (item.ItemType == ToolbarItemType.Dropdown)
                    {
                        <ToolbarDropdown Item="item"
                                       IsActive="item.IsActive(EditorState)"
                                       IsEnabled="item.IsEnabled(EditorState)"
                                       EditorState="EditorState"
                                       OnChildItemClick="HandleDropdownChildClick"
                                       OnDropdownCreated="RegisterDropdown" />
                    }
                    else
                    {
                        <ToolbarButton Item="item"
                                     IsActive="item.IsActive(EditorState)"
                                     IsEnabled="item.IsEnabled(EditorState)"
                                     OnClick="() => OnItemExecuted.InvokeAsync(itemRef.ItemId)" />
                    }
                </div>
            }
        }
    }
}

@code {
    [Parameter] public ToolbarLayout ToolbarLayout { get; set; } = ToolbarLayout.Default;
    [Parameter] public EditorState EditorState { get; set; } = new();
    [Parameter] public EventCallback<string> OnItemExecuted { get; set; }

    private List<ToolbarDropdown> _dropdownRefs = [];

    private async Task HandleDropdownChildClick(IToolbarItem childItem)
    {
        // Execute the child item
        await OnItemExecuted.InvokeAsync(childItem.Id);
    }

    public void RegisterDropdown(ToolbarDropdown dropdown)
    {
        if (!_dropdownRefs.Contains(dropdown))
        {
            _dropdownRefs.Add(dropdown);
        }
    }

    public void CloseAllDropdowns()
    {
        foreach (var dropdown in _dropdownRefs)
        {
            dropdown.CloseDropdown();
        }
    }
}
